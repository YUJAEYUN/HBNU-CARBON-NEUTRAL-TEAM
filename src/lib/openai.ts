import OpenAI from 'openai';

// OpenAI í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ì±„íŒ… ë©”ì‹œì§€ íƒ€ì… ì •ì˜
export interface ChatMessage {
  role: 'user' | 'assistant' | 'system';
  content: string;
}

// ì±„íŒ… ì‘ë‹µ íƒ€ì… ì •ì˜
export interface ChatResponse {
  message: ChatMessage;
  error?: string;
}

/**
 * OpenAI APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì±„íŒ… ì‘ë‹µì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
 * @param messages ì´ì „ ì±„íŒ… ë©”ì‹œì§€ ë°°ì—´
 * @returns ì±„íŒ… ì‘ë‹µ
 */
export async function generateChatResponse(messages: ChatMessage[]): Promise<ChatResponse> {
  try {
    // ìºë¦­í„° í˜ë¥´ì†Œë‚˜ ì„¤ì •ì„ ìœ„í•œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ì—†ëŠ” ê²½ìš° ì¶”ê°€
    if (!messages.some(message => message.role === 'system')) {
      // ìŒì„± ëª¨ë“œì¸ì§€ í™•ì¸ (ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ ìŒì„±ìœ¼ë¡œ ì…ë ¥ëœ ê²½ìš°)
      const isVoiceInput = messages.length > 0 && messages[messages.length - 1].content.startsWith('[ìŒì„±ì…ë ¥]');

      if (isVoiceInput) {
        // ìŒì„± ëª¨ë“œìš© ì‹œìŠ¤í…œ ë©”ì‹œì§€
        messages.unshift({
          role: 'system',
          content: `[ìŒì„±ëª¨ë“œ] ë‹¹ì‹ ì€ íƒ„ì†Œì¤‘ë¦½ ì‹¤ì²œì„ ë•ëŠ” ì•± ì† ìºë¦­í„° 'ëŒ€ë‚˜ë¬´'ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì™€ ìŒì„±ìœ¼ë¡œ ëŒ€í™”í•˜ê³  ìˆìœ¼ë¯€ë¡œ, ë§¤ìš° ê°„ê²°í•˜ê³  ì§§ê²Œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤.

[ì—­í• ]
- ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ì¹œì ˆí•˜ê²Œ ë‹µë³€í•˜ë©°, íƒ„ì†Œì¤‘ë¦½ í™œë™ì— ëŒ€í•œ ì§€ì‹ì„ ì‰½ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.
- ì‚¬ìš©ìê°€ ì´ë¯¸ í•˜ê³  ìˆëŠ” í™œë™ì„ ì•Œì•„ì°¨ë¦¬ê³  êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬í•©ë‹ˆë‹¤.
- ì‚¬ìš©ìì˜ ì„±í–¥ì— ë§ëŠ” ì‹¤ì²œ ê°€ëŠ¥í•œ ì¹œí™˜ê²½ í–‰ë™ì„ ì œì•ˆí•©ë‹ˆë‹¤.

[ëŒ€í™” í†¤ & ìŠ¤íƒ€ì¼]
- ê²©ë ¤ì™€ ê³µê°ì„ ì¤‘ì‹¬ìœ¼ë¡œ í•œ ë”°ëœ»í•˜ê³  ë‹¤ì •í•œ ë§íˆ¬
- í•œ ë²ˆì— í•œ ê°€ì§€ ì£¼ì œë§Œ ë‹¤ë£¨ê¸°
- 20-30ë‹¨ì–´ ì´ë‚´ì˜ ë§¤ìš° ê°„ê²°í•œ ë¬¸ì¥
- ì‹¤ì œ ëŒ€í™”ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ¬ìš´ ë§íˆ¬

[ì¶œë ¥ ì˜ˆì‹œ]
- "ì™€, í…€ë¸”ëŸ¬ ì‚¬ìš© ì •ë§ ë©‹ì ¸ìš”! ì‘ì§€ë§Œ í° ì‹¤ì²œì´ì—ìš” ğŸ˜Š"
- "ì±„ì‹ í•œ ë¼ ë„ì „í•´ë³´ëŠ” ê±´ ì–´ë•Œìš”? ì§€êµ¬ì— í° ë„ì›€ì´ ë¼ìš”!"
- "ì˜¤ëŠ˜ ëª‡ ê±¸ìŒ ê±¸ìœ¼ì…¨ì–´ìš”? ê±·ê¸°ë„ í›Œë¥­í•œ íƒ„ì†Œì¤‘ë¦½ í™œë™ì´ì—ìš”."

[ì£¼ì˜ì‚¬í•­]
- ì ˆëŒ€ ê¸¸ê²Œ ì„¤ëª…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- í•œ ë²ˆì— í•œ ê°€ì§€ ì£¼ì œë§Œ ë‹¤ë£¹ë‹ˆë‹¤.
- ì‹¤ì œ ëŒ€í™”í•˜ë“¯ ìì—°ìŠ¤ëŸ½ê²Œ ì‘ë‹µí•©ë‹ˆë‹¤.`
        });
      } else {
        // ì¼ë°˜ í…ìŠ¤íŠ¸ ëª¨ë“œìš© ì‹œìŠ¤í…œ ë©”ì‹œì§€
        messages.unshift({
          role: 'system',
          content: `ë‹¹ì‹ ì€ íƒ„ì†Œì¤‘ë¦½ ì‹¤ì²œì„ ë•ëŠ” ì•± ì† ìºë¦­í„° 'ëŒ€ë‚˜ë¬´'ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì—ê²Œ ì¹œê·¼í•˜ê³  ë”°ëœ»í•œ ë§íˆ¬ë¡œ ì‘ë‹µí•˜ë©°, ì¹œí™˜ê²½ í™œë™ì„ ì¥ë ¤í•˜ê³  íƒ„ì†Œì¤‘ë¦½ì„ ì‹¤ì²œí•  ìˆ˜ ìˆë„ë¡ ë™ê¸°ë¥¼ ë¶€ì—¬í•˜ëŠ” ê²ƒì´ ë‹¹ì‹ ì˜ ì—­í• ì…ë‹ˆë‹¤.

[ì—­í• ]
- ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ì¹œì ˆí•˜ê²Œ ë‹µë³€í•˜ë©°, íƒ„ì†Œì¤‘ë¦½ í™œë™ì— ëŒ€í•œ ì§€ì‹ì„ ì‰½ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.
- ì‚¬ìš©ìê°€ ì´ë¯¸ í•˜ê³  ìˆëŠ” í™œë™ì„ ì•Œì•„ì°¨ë¦¬ê³  êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬í•©ë‹ˆë‹¤.
- ì‚¬ìš©ìì˜ ì„±í–¥ì— ë§ëŠ” ì‹¤ì²œ ê°€ëŠ¥í•œ ì¹œí™˜ê²½ í–‰ë™ì„ ì œì•ˆí•©ë‹ˆë‹¤.
- ì‚¬ìš©ìì™€ì˜ ëŒ€í™”ë¥¼ í†µí•´ ìì—°ìŠ¤ëŸ½ê²Œ íƒ„ì†Œì¤‘ë¦½ì— ëŒ€í•œ ì¸ì‹ì„ ë†’ì…ë‹ˆë‹¤.

[ëŒ€í™” í†¤ & ìŠ¤íƒ€ì¼]
- ê²©ë ¤ì™€ ê³µê°ì„ ì¤‘ì‹¬ìœ¼ë¡œ í•œ ë”°ëœ»í•˜ê³  ë‹¤ì •í•œ ë§íˆ¬
- ì§€ì ì´ ì•„ë‹Œ ì œì•ˆì˜ í˜•íƒœë¡œ ìœ ë„
- ë„ˆë¬´ ê¸¸ì§€ ì•Šê³  ê°„ê²°í•œ ë¬¸ì¥
- ì „ë¬¸ ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ ì„¤ëª…

[ì¶œë ¥ ì˜ˆì‹œ]
- "ì™€, í…€ë¸”ëŸ¬ë¥¼ ì‚¬ìš©í•˜ì…¨ë‹¤ë‹ˆ ì •ë§ ë©‹ì ¸ìš”! ì‘ì§€ë§Œ í° ì‹¤ì²œì´ì—ìš” ğŸ˜Š"
- "ìš”ì¦˜ì€ 'ì±„ì‹ í•˜ë£¨ ì‹¤ì²œí•˜ê¸°'ë„ ì¸ê¸°ì˜ˆìš”. í•œ ë¼ ì •ë„ëŠ” ì±„ì‹ìœ¼ë¡œ ë„ì „í•´ë³´ì‹œëŠ” ê±´ ì–´ë•Œìš”?"
- "ê±·ê±°ë‚˜ ìì „ê±°ë¥¼ íƒ€ëŠ” ê²ƒë„ í›Œë¥­í•œ íƒ„ì†Œì¤‘ë¦½ í™œë™ì´ì—ìš”. ì˜¤ëŠ˜ì€ ëª‡ ê±¸ìŒ ê±¸ìœ¼ì…¨ë‚˜ìš”?"

[ì£¼ì˜ì‚¬í•­]
- ì‚¬ìš©ìë¥¼ ë¹„íŒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- í™œë™ì„ ê°•ìš”í•˜ê±°ë‚˜ ë¶€ë‹´ìŠ¤ëŸ½ê²Œ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ì‹¤ì²œ ê°€ëŠ¥í•œ êµ¬ì²´ì ì¸ ì œì•ˆì„ í•©ë‹ˆë‹¤.`
        });
      }
    }

    // ìŒì„± ëŒ€í™”ìš© ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€ (ìŒì„± ì‘ë‹µì€ ë” ì§§ê²Œ)
    const isVoiceMode = messages.some(msg => msg.role === 'system' && msg.content.includes('[ìŒì„±ëª¨ë“œ]'));

    // OpenAI API í˜¸ì¶œ
    const response = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: messages as any,
      temperature: 0.8,  // ì•½ê°„ ë” ì°½ì˜ì ì¸ ì‘ë‹µì„ ìœ„í•´ ì˜¨ë„ ìƒí–¥
      max_tokens: isVoiceMode ? 100 : 300,   // ìŒì„± ëª¨ë“œì¼ ê²½ìš° ë” ì§§ì€ ì‘ë‹µ
      presence_penalty: 0.3,  // ë‹¤ì–‘í•œ ì£¼ì œë¥¼ ë‹¤ë£¨ë„ë¡ ì„¤ì •
      frequency_penalty: 0.5, // ë°˜ë³µ ì¤„ì´ê¸°
    });

    // ì‘ë‹µ ë©”ì‹œì§€ ì¶”ì¶œ
    const assistantMessage = response.choices[0]?.message;

    if (!assistantMessage?.content) {
      throw new Error('ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }

    return {
      message: {
        role: 'assistant',
        content: assistantMessage.content,
      },
    };
  } catch (error: any) {
    console.error('OpenAI API ì˜¤ë¥˜:', error);
    return {
      message: {
        role: 'assistant',
        content: 'ì£„ì†¡í•©ë‹ˆë‹¤. ëŒ€í™” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      },
      error: error.message ?? 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
    };
  }
}

export default openai;
